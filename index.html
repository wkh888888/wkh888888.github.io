<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="不积跬步，无以至千里！">
<meta property="og:type" content="website">
<meta property="og:title" content="吴哈哈与卢亲亲">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="吴哈哈与卢亲亲">
<meta property="og:description" content="不积跬步，无以至千里！">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="walker²⁰²³">
<meta property="article:tag" content="吴哈哈,卢亲亲">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>吴哈哈与卢亲亲</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">吴哈哈与卢亲亲</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">从此，有人问我粥可温，有人与我共黄昏。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/06/09/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E5%9D%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="walker²⁰²³">
      <meta itemprop="description" content="不积跬步，无以至千里！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴哈哈与卢亲亲">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/09/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E5%9D%91/" class="post-title-link" itemprop="url">Java线程池的坑</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-09 23:53:56" itemprop="dateCreated datePublished" datetime="2020-06-09T23:53:56+08:00">2020-06-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-08-01 23:32:48" itemprop="dateModified" datetime="2023-08-01T23:32:48+08:00">2023-08-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近在优化代码（把一个大任务变成使用多线程分批执行小任务），使用多线程首当其冲就是使用线程池，一般比较常用的就是Executors.newFixedThreadPool，毕竟有现成的就用是菜鸟的一贯风格，然而却不知道已经掉入坑中了。</p>
<h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>优化完代码后，自测是一个好的开发必做的事情，毕竟好的开发不应该让测试太劳累，首先来常规的边界值测试，把每一批执行的量设置为1，尽可能的模拟多批次，在某个界面操作完后，再次点其中操作特定的界面，发现卡在那里，前端等待后端响应。（内心os：我可真是个写bug小能手）</p>
<h2 id="排查"><a href="#排查" class="headerlink" title="排查"></a>排查</h2><p>一般前端卡在那里，基本就是数据库连接池不用够用，java线程池被占满。</p>
<ol>
<li>首先排查是否是数据库连接池的问题，连接数据库show processlist一下，你想看的不想看的都能看到，发现都是sleep，睡得可香呢，不打扰，不打扰。</li>
<li>接下来，矛头直指java线程池，为了方便排查，作为写外挂小能手的我，二话不说就写一个接口，用于查看线程池里的线程的情况，主要就是看activeCount和completedTaskCount。</li>
</ol>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>万事俱备，只等再来一次，解决问题的前提是复现问题，按照流程又来了一次，果不其然，又卡在那里了，看了一下我的接口，activeCount被占得死死的，小样你的锅跑不掉了。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>Executors 是一个Java中的工具类。提供工厂方法来创建不同类型的线程池。newFiexedThreadPool(int Threads)：创建固定数目线程的线程池。<br>咋一看好像没毛病，JDK自身提供的构建线程池的方式，又用到了工厂模式、又有比较强的扩展性，重要的是用起来还比较方便，多重光环加身，让你无法说不。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lazy</span> <span class="keyword">val</span> threadPool = <span class="type">Executors</span>.newFixedThreadPool(<span class="number">20</span>)</span><br></pre></td></tr></table></figure>
<p>创建一个固定大小的线程池就这么简单，省时省力省心。</p>
<p>但是知人知面不知心，让我们进一步查看源码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a thread pool that reuses a fixed number of threads</span></span><br><span class="line"><span class="comment">     * operating off a shared unbounded queue.  At any point, at most</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> nThreads&#125; threads will be active processing tasks.</span></span><br><span class="line"><span class="comment">     * If additional tasks are submitted when all threads are active,</span></span><br><span class="line"><span class="comment">     * they will wait in the queue until a thread is available.</span></span><br><span class="line"><span class="comment">     * If any thread terminates due to a failure during execution</span></span><br><span class="line"><span class="comment">     * prior to shutdown, a new one will take its place if needed to</span></span><br><span class="line"><span class="comment">     * execute subsequent tasks.  The threads in the pool will exist</span></span><br><span class="line"><span class="comment">     * until it is explicitly &#123;<span class="doctag">@link</span> ExecutorService#shutdown shutdown&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nThreads the number of threads in the pool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the newly created thread pool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if &#123;<span class="doctag">@code</span> nThreads &lt;= 0&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads,</span><br><span class="line">                                      <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                      <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>LinkedBlockingQueue成功的引起了我的注意，这个是个啥玩意，点进去一看。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a &#123;<span class="doctag">@code</span> LinkedBlockingQueue&#125; with a capacity of</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> Integer#MAX_VALUE&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LinkedBlockingQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Java中的BlockingQueue主要有两种实现，分别是ArrayBlockingQueue 和 LinkedBlockingQueue。</p>
<p>ArrayBlockingQueue是一个用数组实现的有界阻塞队列，必须设置容量。</p>
<p>LinkedBlockingQueue是一个用链表实现的有界阻塞队列，容量可以选择进行设置，不设置的话，将是一个无边界的阻塞队列，最大长度为Integer.MAX_VALUE。</p>
<p>这里的问题就出在：不设置的话，将是一个无边界的阻塞队列，最大长度为Integer.MAX_VALUE。也就是说，如果我们不设置LinkedBlockingQueue的容量的话，其默认容量将会是Integer.MAX_VALUE。</p>
<p>而newFixedThreadPool中创建LinkedBlockingQueue时，并未指定容量。此时，LinkedBlockingQueue就是一个无边界队列，对于一个无边界队列来说，是可以不断的向队列中加入任务的，这种情况下就有可能因为任务过多而导致内存溢出问题。</p>
<p><em><strong>以上的是大坑，以下的是小坑</strong></em></p>
<ul>
<li><strong>任务提交后长时间没有执行</strong><br>任务进入了队列，线程还在执行之前的任务。本质原因是对线程和队列的优先级认识不深刻，有一种错觉以为是所有线程都忙的时候才进入任务队列。实际上相反，是队列满的时候才会新建线程（线程数大于core size时）。</li>
<li><strong>线程池中线程执行任务中无故消失（从日志可以看出，任务并未完成，也没有抛出异常）</strong><br>一般情况下，代码中只会去捕捉RuntimeException，如果抛出Error则会导致线程退出，而异常信息又没有拿到。最佳的解决办法是给线程池设置UncaughtExceptionHandler</li>
</ul>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>首先让我看其他三种创建线程池的方式：newSingleThreadExecutor、newCachedThreadPool、newScheduledThreadPool，要不就是无边界队列导致OOM，要不就是创建的最大线程数导致OOM，都有坑，只能自定义创建线程池了。写个方法方便使用。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 不使用系统自带的四个Executors，有坑，轻则线程中任务没有执行，重则OOM导致系统崩掉</span></span><br><span class="line"><span class="comment">    * 使用有边界队列，超出队列的情况返回给调用者执行</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @param nThreads</span></span><br><span class="line"><span class="comment">    * @return</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">newFixedThreadPool</span></span>(nThreads: <span class="type">Int</span>): <span class="type">ThreadPoolExecutor</span> = &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">ThreadPoolExecutor</span>(nThreads, nThreads, <span class="number">3</span>L, <span class="type">TimeUnit</span>.<span class="type">SECONDS</span>, <span class="keyword">new</span> <span class="type">ArrayBlockingQueue</span>(nThreads),</span><br><span class="line">      <span class="type">Executors</span>.defaultThreadFactory, <span class="keyword">new</span> <span class="type">ThreadPoolExecutor</span>.<span class="type">CallerRunsPolicy</span>)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>corePoolSize- 核心池大小。需要注意的是在初创建线程池时线程不会立即启动，直到有任务提交才开始启动线程并逐渐时线程数目达到corePoolSize。若想一开始就创建所有核心线程需调用prestartAllCoreThreads方法。</p>
<p>maximumPoolSize-池中允许的最大线程数。需要注意的是当核心线程满且阻塞队列也满时才会判断当前线程数是否小于最大线程数，并决定是否创建新线程。</p>
<p>keepAliveTime - 当线程数大于核心时，多于的空闲线程最多存活时间</p>
<p>unit - keepAliveTime 参数的时间单位。</p>
<p>workQueue - 当线程数目超过核心线程数时用于保存任务的队列。主要有3种类型的BlockingQueue可供选择：无界队列，有界队列和同步移交。从参数中可以看到，此队列仅保存实现Runnable接口的任务。 别看这个参数位置很靠后，但是真的很重要，有的坑就因这个参数而起，这些细节有必要仔细了解清楚。</p>
<p>threadFactory - 执行程序创建新线程时使用的工厂。</p>
<p>handler - 阻塞队列已满且线程数达到最大值时所采取的饱和策略。java默认提供了4种饱和策略的实现方式：中止、抛弃、抛弃最旧的、调用者运行。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>不要使用系统自带的四个Executors，有坑，轻则线程中任务没有执行，重则OOM导致系统崩掉，使用自定义创建线程池，参数根据实际的场景设置。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/340f23001a65">Java线程池使用的注意事项</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/-89-CcDnSLBYy3THmcLEdQ">深入源码分析Java线程池的实现原理</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/32867181">一次Java线程池误用引发的血案和总结</a><br><a target="_blank" rel="noopener" href="https://www.hollischuang.com/archives/2888">Java中线程池，你真的会用吗？</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/03/05/%E9%92%89%E9%92%89%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="walker²⁰²³">
      <meta itemprop="description" content="不积跬步，无以至千里！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴哈哈与卢亲亲">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/05/%E9%92%89%E9%92%89%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">钉钉接口开发入门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-05 13:51:50" itemprop="dateCreated datePublished" datetime="2019-03-05T13:51:50+08:00">2019-03-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-08-01 23:34:51" itemprop="dateModified" datetime="2023-08-01T23:34:51+08:00">2023-08-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="需求背景："><a href="#需求背景：" class="headerlink" title="需求背景："></a>需求背景：</h1><p>将一个A系统接入钉钉平台，供该企业内部员工使用等，实现移动化办公。<br>主要需求：</p>
<ol>
<li>可以使用钉钉通过扫描二维码的方式登录A系统</li>
<li>可以在A系统中共享钉钉的组织架构</li>
</ol>
<h1 id="技术调研思路："><a href="#技术调研思路：" class="headerlink" title="技术调研思路："></a>技术调研思路：</h1><h2 id="第一阶段：在钉钉官网查看开发者文档"><a href="#第一阶段：在钉钉官网查看开发者文档" class="headerlink" title="第一阶段：在钉钉官网查看开发者文档"></a>第一阶段：在钉钉官网查看开发者文档</h2><p>接入场景主要有四种：</p>
<ul>
<li>企业内部开发 <a target="_blank" rel="noopener" href="https://open-doc.dingtalk.com/microapp/bgb96b">https://open-doc.dingtalk.com/microapp/bgb96b</a></li>
<li>第三方企业应用 <a target="_blank" rel="noopener" href="https://open-doc.dingtalk.com/microapp/isv">https://open-doc.dingtalk.com/microapp/isv</a></li>
<li>第三方个人应用 <a target="_blank" rel="noopener" href="https://open-doc.dingtalk.com/microapp/personnal">https://open-doc.dingtalk.com/microapp/personnal</a></li>
<li>移动应用接入 <a target="_blank" rel="noopener" href="https://open-doc.dingtalk.com/microapp/native">https://open-doc.dingtalk.com/microapp/native</a></li>
</ul>
<h2 id="第二阶段：选择可行方案"><a href="#第二阶段：选择可行方案" class="headerlink" title="第二阶段：选择可行方案"></a>第二阶段：选择可行方案</h2><p>根据需求，我们的使用场景为：仅供某个企业内的成员使用，其他企业无法使用该应用，所以优先选择企业内部开发方案。</p>
<h3 id="企业内部开发"><a href="#企业内部开发" class="headerlink" title="企业内部开发"></a>企业内部开发</h3><p>基于钉钉的开放能力，自主开发，供企业或组织内部使用，以满足办公场景中的个性化需求。该类应用无需钉钉团队审核。</p>
<h3 id="应用类型"><a href="#应用类型" class="headerlink" title="应用类型"></a>应用类型</h3><p>可以开发E应用、微应用两种类型的应用。</p>
<p>E应用是一种全新的开发模式，让移动开发者通过简捷的前端语法写出Native级别的性能体验，并支持iOS、安卓、等多端部署。E应用暂不支持PC端部署，如果您的应用必须要在PC端上使用，可暂时使用微应用开发方式。<br>微应用是指用H5方式开发的应用。</p>
<p>E应用和微应用的对比：</p>
<table>
<thead>
<tr>
<th></th>
<th>E应用</th>
<th>H5微应用</th>
</tr>
</thead>
<tbody><tr>
<td>加载性能</td>
<td>首次使用略慢，后续加载快</td>
<td>受到很多因素影响，优化不够好，容易慢</td>
</tr>
<tr>
<td>使用体验</td>
<td>非常顺滑，接近 Native</td>
<td>容易卡顿</td>
</tr>
<tr>
<td>开发环境搭建</td>
<td>提供 IDE，快速创建项目</td>
<td>成本高</td>
</tr>
<tr>
<td>调试</td>
<td>提供 IDE，可以在电脑上调试大部分功能</td>
<td>在电脑上只能调 UI，涉及到钉钉的 jsapi，必须真机调试</td>
</tr>
<tr>
<td>使用开源 UI 组件</td>
<td>目前不支持</td>
<td>支持</td>
</tr>
<tr>
<td>使用 npm 包</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>模块化组织代码</td>
<td>支持 E应用 特有的模块化</td>
<td>使用 vue, React 等框架可以轻松获得模块化支持</td>
</tr>
<tr>
<td>灰度发布</td>
<td>钉钉提供</td>
<td>需要自己实现</td>
</tr>
<tr>
<td>CDN</td>
<td>E应用包默认在 CDN</td>
<td>需要开发者自己购买相关服务</td>
</tr>
<tr>
<td>开发个人应用</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>应用离线化</td>
<td>支持</td>
<td>不支持</td>
</tr>
</tbody></table>
<p>由于E应用主要针对手机平台，ios 和 android，而且暂不支持在PC端使用。E应用比较坑人的地方是必须购买阿里云的服务器，而且基础版的价格是2万每年。（果断放弃！）</p>
<p>比较并验证可行性之后，最终选择实现方案：钉钉微应用接入（企业内部开发）</p>
<h1 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h1><h2 id="创建应用"><a href="#创建应用" class="headerlink" title="创建应用"></a>创建应用</h2><ol>
<li>企业管理员登录钉钉管理后台，选择导航【工作台】，点击【自建应用】，开始创建自建应用。</li>
<li>填写基础信息<br>填写应用基本信息。包括应用名称、logo和简介等。选择企业内部自主开发。</li>
<li>开发模式选择“开发应用”，应用类型选择“微应用”。</li>
<li>创建成功过后，会生成appKey和appSecret，可获取access_token进行开发</li>
</ol>
<h2 id="开发应用"><a href="#开发应用" class="headerlink" title="开发应用"></a>开发应用</h2><p>钉钉开放平台提供丰富的API接口，以便开发者接入。</p>
<p>钉钉开放平台提供了企业通讯录管理、文件管理、发送企业会话消息等功能，接口使用可以参考服务端开发文档。<a target="_blank" rel="noopener" href="https://open-doc.dingtalk.com/microapp/serverapi2/gh60vz">https://open-doc.dingtalk.com/microapp/serverapi2/gh60vz</a><br>钉钉开放平台提供了微应用在钉钉客户端运行的专用容器，并提供一组可以调用钉钉的本地能力和业务能力的JSAPI接口，JSAPI接口用于微应用与钉钉功能之间的结合，接口使用可以参考客户端开发文档。<a target="_blank" rel="noopener" href="https://open-doc.dingtalk.com/microapp/dev/welcome-to-lark">https://open-doc.dingtalk.com/microapp/dev/welcome-to-lark</a></p>
<h2 id="扫码登录第三方网站"><a href="#扫码登录第三方网站" class="headerlink" title="扫码登录第三方网站"></a>扫码登录第三方网站</h2><p>使用钉钉客户端扫码并确认登录您的web系统，在您的系统内获得正在访问用户的钉钉身份，而用户无需输入账户密码。</p>
<p>注: 此功能与企业自建应用&#x2F;第三方企业应用无关，只能用扫码登录打开第三方网站，并且不是钉钉内的应用免登，此流程只能做到获取到用户身份（无手机号和企业相关信息）。</p>
<h3 id="获取appId及appSecret"><a href="#获取appId及appSecret" class="headerlink" title="获取appId及appSecret"></a>获取appId及appSecret</h3><p>点击进入<a target="_blank" rel="noopener" href="https://open-dev.dingtalk.com/">钉钉开发者平台</a> 的页面，点击左侧菜单的【<strong>移动接入应用</strong>】<strong>，</strong>然后点击右上角的【<strong>创建扫码登录应用授权</strong>】，创建用于免登过程中验证身份的appId及appSecret，创建后即可看到appId和appSecret。</p>
<h3 id="构造扫码登录页面"><a href="#构造扫码登录页面" class="headerlink" title="构造扫码登录页面"></a>构造扫码登录页面</h3><ul>
<li>第一种方式是直接使用钉钉提供的扫码登录页面<br>在企业Web系统里，用户点击使用钉钉扫描登录，第三方Web系统跳转到如下地址：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://oapi.dingtalk.com/connect/qrconnect?appid=APPID&amp;response_type=code&amp;scope=snsapi_login&amp;state=STATE&amp;redirect_uri=REDIRECT_URI</span><br></pre></td></tr></table></figure>
url里的参数需要换成第三方Web系统对应的参数。在钉钉用户扫码登录并确认后，会302到你指定的redirect_uri，并向url参数中追加临时授权码code及state两个参数。</li>
<li>第二种方式是支持网站将钉钉登录二维码内嵌到自己页面中<br>用户使用钉钉扫码登录后JS会将loginTmpCode返回给网站。JS钉钉登录主要用途：网站希望用户在网站内就能完成登录，无需跳转到钉钉域下登录后再返回，提升钉钉登录的流畅性与成功率。<br><a target="_blank" rel="noopener" href="https://open-doc.dingtalk.com/microapp/serverapi2/kymkv6#a-namegpdvgqa%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%98%AF%E6%94%AF%E6%8C%81%E7%BD%91%E7%AB%99%E5%B0%86%E9%92%89%E9%92%89%E7%99%BB%E5%BD%95%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%86%85%E5%B5%8C%E5%88%B0%E8%87%AA%E5%B7%B1%E9%A1%B5%E9%9D%A2%E4%B8%AD">https://open-doc.dingtalk.com/microapp/serverapi2/kymkv6#a-namegpdvgqa%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%98%AF%E6%94%AF%E6%8C%81%E7%BD%91%E7%AB%99%E5%B0%86%E9%92%89%E9%92%89%E7%99%BB%E5%BD%95%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%86%85%E5%B5%8C%E5%88%B0%E8%87%AA%E5%B7%B1%E9%A1%B5%E9%9D%A2%E4%B8%AD</a></li>
</ul>
<h2 id="同步组织架构"><a href="#同步组织架构" class="headerlink" title="同步组织架构"></a>同步组织架构</h2><p>调用钉钉提供的相关接口<br>用户管理：<a target="_blank" rel="noopener" href="https://open-doc.dingtalk.com/microapp/serverapi2/ege851">https://open-doc.dingtalk.com/microapp/serverapi2/ege851</a><br>部门管理：<a target="_blank" rel="noopener" href="https://open-doc.dingtalk.com/microapp/serverapi2/dubakq">https://open-doc.dingtalk.com/microapp/serverapi2/dubakq</a><br>角色管理：<a target="_blank" rel="noopener" href="https://open-doc.dingtalk.com/microapp/serverapi2/dnu5l1">https://open-doc.dingtalk.com/microapp/serverapi2/dnu5l1</a></p>
<h1 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h1><p>开发前必读：<a target="_blank" rel="noopener" href="https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.6c7e4a978KksTn&treeId=385&articleId=104980&docType=1">https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.6c7e4a978KksTn&amp;treeId=385&amp;articleId=104980&amp;docType=1</a></p>
<p>企业内部开发常见问题：<a target="_blank" rel="noopener" href="https://open-doc.dingtalk.com/microapp/bgb96b/mdg058">https://open-doc.dingtalk.com/microapp/bgb96b/mdg058</a></p>
<p>开发企业内部应用：<a target="_blank" rel="noopener" href="https://open-doc.dingtalk.com/microapp/bgb96b/gt5d6a">https://open-doc.dingtalk.com/microapp/bgb96b/gt5d6a</a></p>
<p>钉钉微应用接入（企业内部开发）：<a target="_blank" rel="noopener" href="https://blog.csdn.net/Jason847/article/details/75007140/">https://blog.csdn.net/Jason847/article/details/75007140/</a></p>
<p>扫码登录第三方网站：<a target="_blank" rel="noopener" href="https://open-doc.dingtalk.com/microapp/serverapi2/kymkv6">https://open-doc.dingtalk.com/microapp/serverapi2/kymkv6</a></p>
<p>JavaWeb开发<br>初步实现网站应用钉钉扫码登录：<a target="_blank" rel="noopener" href="https://blog.csdn.net/baofeidyz/article/details/59059379">https://blog.csdn.net/baofeidyz/article/details/59059379</a></p>
<p>第三方网站通过 钉钉 扫描二维码登录&#x2F;免密码登录，获取手机号码、邮箱等信息：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6a61043c79c9">https://www.jianshu.com/p/6a61043c79c9</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/11/09/%E5%AE%9E%E7%8E%B0%E6%8C%87%E5%AE%9A%E6%9C%8D%E5%8A%A1%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="walker²⁰²³">
      <meta itemprop="description" content="不积跬步，无以至千里！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴哈哈与卢亲亲">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/11/09/%E5%AE%9E%E7%8E%B0%E6%8C%87%E5%AE%9A%E6%9C%8D%E5%8A%A1%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF/" class="post-title-link" itemprop="url">Linux 实现指定服务开机自启</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-11-09 00:40:06" itemprop="dateCreated datePublished" datetime="2017-11-09T00:40:06+08:00">2017-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-08-01 23:59:10" itemprop="dateModified" datetime="2023-08-01T23:59:10+08:00">2023-08-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本教程介绍在CentOS 7服务器上实现指定服务开机自启。<br>1.用sh脚本实现启动服务<br>vim itService-start.sh # 编辑脚本，内容如下：</p>
<p>#!&#x2F;bin&#x2F;sh</p>
<p>DIR&#x3D;$(cd “$(dirname “$0”)” &amp;&amp; pwd) # cd 到脚本所在的目录，并把路径赋值给DIR </p>
<p>classPath&#x3D;$DIR&#x2F;itservice-0.1.jar # 把要运行的jar包赋值给classPath</p>
<p>mainClass&#x3D;s.com.wkh.ItService # 把主函数入口赋值给classPath</p>
<p>shLogPath&#x3D;$DIR&#x2F;sh_start.log # 把启动脚本日志赋值给shLogPath</p>
<p>jps | grep ItService | awk “{print $1}” | xargs kill -9 &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1 # 获取该服务的进程号并强制结束进程</p>
<p>nohup java -cp “$classPath” “$mainClass” &gt;”$shLogPath” &amp; # 后台运行jar包</p>
<p>jps # 显示当前所有java进程pid</p>
<p>至此就可以用itService-start.sh启动该服务了。</p>
<p>2.注册成一个系统服务<br>服务脚本必须存放在&#x2F;etc&#x2F;ini.d&#x2F;目录下；</p>
<p>vim &#x2F;etc&#x2F;init.d&#x2F;itservice # 编辑脚本，内容如下：</p>
<p>#!&#x2F;bin&#x2F;sh</p>
<h3 id="BEGIN-INIT-INFO"><a href="#BEGIN-INIT-INFO" class="headerlink" title="BEGIN INIT INFO"></a>BEGIN INIT INFO</h3><h1 id="Provides-itservice"><a href="#Provides-itservice" class="headerlink" title="Provides:          itservice"></a>Provides:          itservice</h1><h1 id="Default-Start-2-3-4-5"><a href="#Default-Start-2-3-4-5" class="headerlink" title="Default-Start:    2 3 4 5"></a>Default-Start:    2 3 4 5</h1><h1 id="Default-Stop-0-1-6"><a href="#Default-Stop-0-1-6" class="headerlink" title="Default-Stop:      0 1 6"></a>Default-Stop:      0 1 6</h1><h1 id="Description-itservice"><a href="#Description-itservice" class="headerlink" title="Description:      itservice"></a>Description:      itservice</h1><h3 id="END-INIT-INFO"><a href="#END-INIT-INFO" class="headerlink" title="END INIT INFO"></a>END INIT INFO</h3><p>RETVAL&#x3D;0</p>
<p>tdir&#x3D;&#x2F;root&#x2F;itService</p>
<p>pidof&#x3D;<code>jps | grep ItService | awk &#39;&#123;print \$1&#125;&#39;</code></p>
<p>case “$1” in</p>
<p>start)</p>
<p>if [ -z “$pidof” ];then</p>
<p>echo “Starting ItService…”</p>
<p>$tdir&#x2F;itService-start.sh</p>
<p>else</p>
<p>echo “ItService already running”</p>
<p>fi</p>
<p>RETVAL&#x3D;$?</p>
<p>;;</p>
<p>stop)</p>
<p>echo “Stopping ItService…”</p>
<p>[ -z “$pidof” ] &amp;&amp; echo “ItService not running…” || kill $pidof</p>
<p>RETVAL&#x3D;$?</p>
<p>;;</p>
<p>restart)</p>
<p>echo “Stopping ItService…”</p>
<p>echo “Starting ItService…”</p>
<p>$tdir&#x2F;itService-start.sh</p>
<p>RETVAL&#x3D;$?</p>
<p>;;</p>
<p>status)</p>
<p>[ -z “$pidof” ] &amp;&amp; echo “ItService not running…” || echo “ItService running with pid $pidof”</p>
<p>RETVAL&#x3D;$?</p>
<p>;;</p>
<p>*)</p>
<p>echo “Usage: &#x2F;etc&#x2F;init.d&#x2F;itservice {start|stop|restart|status}”</p>
<p>RETVAL&#x3D;$?</p>
<p>;;</p>
<p>esac</p>
<p>exit $RETVAL</p>
<p>至此脚本写完，用chkconfig –add itservice注册成一个系统服务，此时服务会被在&#x2F;etc&#x2F;rc.d&#x2F;rcN.d中赋予K&#x2F;S入口，然后可以用service itservice start来启动了。</p>
<p>3.用chkconfig设置开机自启<br>chkconfig –level 35 itservice on</p>
<p>–level&lt;等级代号&gt; 　指定读系统服务要在哪一个执行等级中开启或关毕。</p>
<p>等级0表示：表示关机</p>
<p>等级1表示：单用户模式</p>
<p>等级2表示：无网络连接的多用户命令行模式</p>
<p>等级3表示：有网络连接的多用户命令行模式</p>
<p>等级4表示：不可用</p>
<p>等级5表示：带图形界面的多用户模式</p>
<p>等级6表示：重新启动</p>
<p>4.常见问题<br>1.sh没有执行权限，解决方案：chmod 700 itService-start.sh</p>
<p>2.chkconfig –add servicename时遇到service xxx does not support chkconfig，解决方案：必须把下面两行注释放在&#x2F;etc&#x2F;init.d&#x2F;itservice文件靠前的注释中：</p>
<h1 id="Default-Start-2-3-4-5-1"><a href="#Default-Start-2-3-4-5-1" class="headerlink" title="Default-Start:    2 3 4 5"></a>Default-Start:    2 3 4 5</h1><h1 id="Default-Stop-0-1-6-1"><a href="#Default-Stop-0-1-6-1" class="headerlink" title="Default-Stop:      0 1 6"></a>Default-Stop:      0 1 6</h1><p>PS: 不在脚本所在目录执行sh时要注意工作目录的问题。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">walker²⁰²³</p>
  <div class="site-description" itemprop="description">不积跬步，无以至千里！</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/wkh888888" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wkh888888" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.jianshu.com/u/0f6c62834a19" title="https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;0f6c62834a19" rel="noopener" target="_blank">个人简书</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023-08-02</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">walker²⁰²³</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  















    <div id="pjax">
  

  

    </div>
</body>
</html>
